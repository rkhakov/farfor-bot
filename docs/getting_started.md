# Начало работы


## Предварительные требования
* [Poetry](https://github.com/python-poetry/poetry) - Используется для управления зависимостями
* `docker-compose` - Для запуска базы на дев окружении


## Клонируем репозиторий
```shell
> git clone git@github.com:rkhakov/farfor-bot.git
> cd farfor-bot
```


## Установка зависимостей
```shell
 poetry install
```
В корне проекта находится файл `poetry.toml` в котором указано создавать виртуальное окружение в проекте.
После установки зависимостей, должна появиться директория c виртуальным окружением `.venv`


## Конфигурация
Копируем пример конфига в файл `.env`
```shell
> cp .env.example .env
```

Для работы с телеграм ботом, нужно указать его токен в поле `TELEGRAM_TOKEN`

Конфигурация поддерживает получение данных из переменных окружения.

> Переменные окружения приоритетнее над файлом `.env`


## Поднимаем базу
```shell
> docker-compose up -d
```


## Накатываем миграции
```shell
> poetry run farfor_bot database upgrade

# Если база отсутствует, то можно запустить команду инициализации
> poetry run farfor_bot database init
```

## Создание дефолтных записей в базе
На данный момент используется только для создания дефолтного супер пользователя.
Логин и пароль пользователя задаются в `.env` файле,
в параметрах `DEFAULT_USER_LOGIN` и `DEFAULT_USER_PASSWORD`
```shell
> poetry run farfor_bot database default_records
```


## Запуск develop окружения
После установки зависимостей можно запустить дев сервер используя CLI.
```shell
> poetry run farfor_bot server develop
```

Посмотреть все доступные команды
```shell
> poetry run farfor_bot --help
```


## Установка прекоммит хуков
```shell
> poetry run pre-commit install
```


## Телеграм вебхук
Для локального тестирования вебхука, можно воспользоваться [ngrok](https://www.npmjs.com/package/ngrok)


## OpenAPI Doc
По умолчанию проект стартут на порту `8900`

* [Документация API](http://127.0.0.1:8900/docs)


## Warnings
После запуска проекта, всплывает предупреждение об устаревших функциях криптографии из библиотеки python-jose.
Пулл реквест с исправлением https://github.com/mpdavis/python-jose/pull/229 был смерджен.
С выходом новой версии нужно будет обновить `python-jose`.